# 메모리 누수 해결 경험


내가 메모리 누수 해결 경험을 적고자 한다
어느날 서비스가 out of memeory 현상으로 죽는 현상이 나타났다
클라우드 워치로 메모리 상황을 봤는데 아래와 그림처럼 우상향을 그렸다

<p align="center">
  <img src="/images/memory_leak/memory_leak_cloud_watch_01.png" alt="book" width="800"/>
</p>  

위 그림은 현재 그림이고 (과거 아주 가파른 메모리 누수 그래프는 찾지 못했다) 메모리 누수가 있지만 감당 가능한 수준인데
그 당시에는 엄청 가파른 우상향 그래프였다
  

따라서 거의 일주일에 한번씩? 또는 3 ~ 4일에 한번씩 out of memory로 서버가 죽기 시작했다
  
다만 서버가 죽으면 다시 자동으로 띄우는 systemctl 명령어로 java를 5초마다 체크해서 프로세스가 안떠있으면 다시 띄우는
시스템 명령어로 해놨지만 3~4일에 죽는건 고치는게 시급해보였다
  

12시나 6시 기점으로 너무나 많은 콜이 들어온다 1초에 약 70개정도이다
왜냐면 우리 서비스는 PASS앱에 있는 부가서비스인데 그 당시 코로나때문에
점심시간이나 저녁시간은 인증을 위해서 PASS앱을 켜야되는데 PASS앱에 접속 할때마다 우리 서버를 찌르기 때문이다.

  
즉 우리 서비스를 직접 이용하지 않아도 부하를 감당해야되는것이다.

  
'패스 앱에 접속하거나 단순 인증 QR코드 요청할때는 우리 서비스를 찌르지 말고
우리 서비스를 실제로 이용할때만 찌르게 만들면 되지 않았을까?'
라고 그 당시에는 생각했지만
지금은 아마 어떠한 이유가 있으리라 추정한다.

  
나도 통신사 연동 경험이 좀 있는데 우리 서비스 로그인할때마다 통신사에게 정보를 요청한다
단순 로그인이어도 항상 연동 api를 해야되는 경우가 있다 그 당시에 싱크가 맞아야만 되기 때문

사족이 너무 길었고
내가 겪은 메모리 누수의 원인을 찾기위해 검색 도중 베민 기술 블로그에 메모리 누수 해결 포스트를 보고 따라했다.

<p align="center">
  <img src="https://techblog.woowahan.com/wp-content/uploads/img/2019-05-24/iamge-003-heapdump-result1.jpg" alt="book" width="800"/>
</p>  

위 그림은 배민에서 가져왔다
내가 작업한 메모리누수 작업자료는 노트북 포맷으로 인해 사라졌다.
나같은 경우는 메모리 1순위가 모델 매퍼였다.

따라서 모델매퍼 소스에서 메모리 누수가 난다고 추정하고 소스를 보기 시작했다
자세한 내용은 모델매퍼 포스트를 확인 바란다.(추후 작업 예정)

원인이 되는 소스는 다음과 같다.
<p align="center">
  <img src="/images/memory_leak/memory_leak_01.png" alt="book" width="800"/>
</p>

위 소스에서 어느부분이 메모리 누수가 나는지 알 수 있겠는가??

DevicePriceEntityToDevicePrice 메소드를 호출할때마다 
매번 새로운 타입을(createTypeMap) 생성해주는게 문제였다.
출처 : https://github.com/modelmapper/modelmapper/issues/375
위 출처로 들어가보면 알겠지만 많은 사람들이
facing the same issue라서 같은 문제를 겪고있는 것을 확인할 수 있다.

<p align="center">
  <img src="https://techblog.woowahan.com/wp-content/uploads/img/2019-05-24/iamge-003-heapdump-result1.jpg" alt="book" width="800"/>
</p>

위와 같이 모델매퍼 공식 문서에 쓰레드 세이프하고 재사용 해야된다고 나와있다.
만약 dependency injection container를 사용하고있다면 모델매퍼 싱글톤 설정을 해야된다고 나와있다.

그래서 나도 싱글톤 설정으로 해서 해결했다.

부하 테스트를 해보니 전과 확실히 다르게 out of memory가 안났다.


나는 주로 단순 매핑할때 모델매퍼를 애용하는편이다.
필드가 10개만 되어도 모델매퍼를 이용하면 꽤 편하다.
모델매퍼가 아니어도 결국은 DTO와 다른 도메인이나 다른 객체를 매핑해줘야되는 경우는 무조건 생기는데
그때 모델매퍼를 이용하면 수고를 덜 수 있다.


결론 : 모델매퍼를 싱글톤으로 제대로 사용하자
(나말고도 많은 사람이 쉽게 잘못된 사용법으로 크리티컬한 메모리 누수가 발생하면 뭔가 조치가 취해져야되는게 아닐까 싶기도 하다)










