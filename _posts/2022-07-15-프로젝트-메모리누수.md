# 메모리 누수 해결 경험


제가 메모리 누수 해결 경험을 적고자 합니다.
어느날 서비스가 out of memeory 현상으로 죽는 현상이 나타났습니다.
클라우드 워치로 메모리 상황을 봤는데 아래와 그림처럼 우상향을 그렸습니다.

<p align="center">
  <img src="/images/memory_leak/memory_leak_cloud_watch_01.png" alt="book" width="800"/>
</p>  

위 그림은 현재 그림이고 (과거 아주 가파른 메모리 누수 그래프는 찾지 못했습니다.) 메모리 누수가 있지만 감당 가능한 수준인데
그 당시에는 엄청 가파른 우상향 그래프였습니다.
  

따라서 거의 일주일에 한번씩? 또는 3 ~ 4일에 한번씩 out of memory로 서버가 죽기 시작했습니다.
  
다만 서버가 죽으면 다시 자동으로 띄우는 systemctl 명령어로 java를 5초마다 체크해서 프로세스가 안떠있으면 다시 띄우는
시스템 명령어로 해놨지만 3~4일에 죽는건 고치는게 시급해보였습니다.
  

12시나 6시 기점으로 너무나 많은 콜이 들어왔습니다. 1초에 약 70개정도입니다.
왜냐면 우리 서비스는 PASS앱에 있는 부가서비스인데 그 당시 코로나때문에
점심시간이나 저녁시간은 인증을 위해서 PASS앱을 켜야되는데 PASS앱에 접속 할때마다 우리 서버를 찌르기 때문입니다.

  
즉 우리 서비스를 직접 이용하지 않아도 부하를 감당해야되는것입니다.

  
'패스 앱에 접속하거나 단순 인증 QR코드 요청할때는 우리 서비스를 찌르지 말고
우리 서비스를 실제로 이용할때만 찌르게 만들면 되지 않았을까?'
라고 그 당시에는 생각했지만
지금은 아마 어떠한 이유가 있으리라 추정합니다.

  
저도 통신사 연동 경험이 좀 있는데 우리 서비스 로그인할때마다 통신사에게 정보를 요청합니다.
단순 로그인이어도 항상 연동 api를 해야되는 경우가 있습니다. 그 당시에 싱크가 맞아야만 되기 때문입니다.

사족이 너무 길었고
내가 겪은 메모리 누수의 원인을 찾기위해 검색 도중 베민 기술 블로그에 메모리 누수 해결 포스트를 보고 따라했습니다.

<p align="center">
  <img src="https://techblog.woowahan.com/wp-content/uploads/img/2019-05-24/iamge-003-heapdump-result1.jpg" alt="book" width="800"/>
</p>  

위 그림은 배민에서 가져왔습니다.
제가 작업한 메모리누수 작업자료는 노트북 포맷으로 인해 사라졌습니다.
저같은 경우는 메모리 1순위가 모델 매퍼였습니다.

따라서 모델매퍼 소스에서 메모리 누수가 난다고 추정하고 소스를 보기 시작했습니다.

원인이 되는 소스는 다음과 같습니다.
<p align="center">
  <img src="/images/memory_leak/memory_leak_01.png" alt="book" width="800"/>
</p>

DevicePriceEntityToDevicePrice 메소드를 호출할때마다 
매번 새로운 타입을(createTypeMap) 생성해주는게 문제였습니다.
출처 : https://github.com/modelmapper/modelmapper/issues/375
위 출처로 들어가보면 알겠지만 많은 사람들이
facing the same issue라서 같은 문제를 겪고있는 것을 확인할 수 있습니다.

<p align="center">
  <img src="/images/memory_leak/memory_leak_03.png" alt="book" width="800"/>
</p>

위와 같이 모델매퍼 공식 문서에 쓰레드 세이프하고 재사용 하는게 최선이라고 나왔습니다.
근데 사실 최선이 아니고 강제로 꼭 재사용을 해야만 합니다 아니면 메모리가 누수가 나기 때문입니다.
만약 dependency injection container를 사용하고있다면 모델매퍼 싱글톤 설정을 해야된다고 나와있습니다.

그래서 저도 싱글톤 설정으로 해서 해결했습니다.

부하 테스트를 해보니 전과 확실히 다르게 out of memory가 안났습니다.


저는 주로 단순 매핑할때 모델매퍼를 애용하는편입니다.
필드가 10개만 되어도 모델매퍼를 이용하면 꽤 편합니다.
모델매퍼가 아니어도 결국은 DTO와 다른 도메인이나 다른 객체를 매핑해줘야되는 경우는 무조건 생기는데
그때 모델매퍼를 이용하면 수고를 덜 수 있습니다.


결론 : 모델매퍼를 싱글톤으로 제대로 사용하자
(저말고도 많은 사람이 쉽게 잘못된 사용법으로 크리티컬한 메모리 누수가 발생하면 뭔가 조치가 취해져야되는게 아닐까 싶기도 합니다.)








이번글에서는 가격알리미 서비스에서 제가 겪은 메모리 누수현상과 그 해결과정을 설명하고자 합니다.  
가격알리미의 서버가 간헐적으로 다운이 됐었고, aws 클라우드 워치로 메모리 현황을 살펴본 결과 메모리 점유율이 가파르게 치솟고 있었습니다.  
<br />
<br />
<br />



일주일에 한두번씩 서버가 죽곤 했는데, 서버다운으로 인한 부작용을 최소화하기 위해 서버가 죽을때 다시 자동으로 재기동하는 프로세스를 사전에 구비했었지만
서버다운의 빈도가 너무 잦다고 판단해 빠르게 해결해나갔습니다.  


12시, 6시 기점으로 서버가 감당할 수 있는 리퀘스트보다도 더 많은 리퀘스트가 발생했습니다(1초당 70회)
저희 서비스는 pass앱 내부에서 이용할 수 있는 부가서비스로,  
당시 코로나 QR체크를 위해 다수의 고객이 식사시간대에 pass앱을 켜면 부가서비스를 이용하지 않는 고객의 요청임에도 불구하고
부하가 발생하면서 나타난 현상이었습니다.  

앱 접속이나, 단순 인증에 관한 요청을 제외한 실제 저희 부가서비스를 이용하는 경우에만 리퀘스트를 발생시키면 되지않을까 라는 생각도 해보았지만  
접속, 단순인증 요청이더라도 항상 연동 api을 사용해야하는 경우가 대부분이라는것을 경험을통해 추정하게 되었습니다.  
<br />
<br />
정확히 어떤 포인트에서 부하가 발생하는지 파악하기 위해 부하테스트를 진행해본결과 
저의 경우에는 모델매퍼가 메모리 점유율 1순위를 차지하고있었습니다.  
따라서 모델매퍼 내부 로직에서 메모리 누수 이슈가 있을것이라 추정해 소스를 분석해보니 매번 새로운 객체를 생성해주면서 발생하는 문제였습니다.  
 
<p align="center">
  <img src="/images/memory_leak/memory_leak_03.png" alt="book" width="800"/>
</p>
위의 faq내용과 같이 모델매퍼 공식 문서에서는 메모리 누수를 피하기 위해서는 쓰레드세이프한경우에만 사용하고, 재사용하는게 최선이며
만약 모델매퍼 의존성을 주입해서 사용하고 있다면, 싱글톤패턴으로 호출하도록 수정해야 한다고 결론지어졌습니다.  

모델 매퍼 무한 객체생성 문제를 해결하고 난 후 다시 부하 테스트를 해보니 예상대로 메모리 누수 현상이 사라졌습니다.  
 (개선된 완만한 메모리사용량 이미지)


결론 : 모델매퍼를 싱글톤으로 제대로 사용하자
(저말고도 많은 사람이 쉽게 잘못된 사용법으로 크리티컬한 메모리 누수가 발생하면 뭔가 조치가 취해져야되는게 아닐까 싶기도 합니다.)
